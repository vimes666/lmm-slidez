#!/bin/bash
# Slideshow generator for Linux Mint Mate by vimes666
 
version="${0##*/} - version 2.3"
input_folder="/usr/share/backgrounds"
output_file="$HOME/.backgrounds/slideshow.xml"
duration=300
cnt=0
usage="Usage: ${0##*/} [-h] [-r] [-v] [-d duration] [-i input-folder] [-o output-file]"

# Write the startdate section
function write_heading {
   echo "<!-- Slideshow generated by $version, $(date +'%Y-%m-%d %H:%M:%S') -->" > $output_file
   echo "<background>" >> $output_file
   echo "  <starttime>" >> $output_file
   echo "    <year>$(date +'%Y')</year>" >> $output_file
   echo "    <month>$(date +'%m')</month>" >> $output_file
   echo "    <day>$(date +'%d')</day>" >> $output_file
   echo "    <hour>$(date +'%H')</hour>" >> $output_file
   echo "    <minute>$(date +'%M')</minute>" >> $output_file
   echo "    <second>$(date +'%S')</second>" >> $output_file
   echo "  </starttime>" >> $output_file
}

# Write the static section
function write_static {
   echo "  <static>" >> $output_file
   echo "    <duration>$duration</duration>" >> $output_file
   echo "    <file>"$line"</file>" >> $output_file
   echo "  </static>" >> $output_file
} 

# Write the transition section
function write_transition {
   echo "  <transition>" >> $output_file
   echo "    <duration>3.0</duration>" >> $output_file
   echo "    <from>"$prevline"</from>" >> $output_file
   echo "    <to>"$line"</to>" >> $output_file
   echo "  </transition>" >> $output_file
}

# Write the tail line
function write_tail {
   echo "</background>" >> $output_file
}

# check switches
while getopts d:hi:o:rv opt; do
   case $opt in
      d)  duration=$OPTARG ;;
      h)  echo "$usage" && exit 0 ;;
      i)  input_folder=$OPTARG ;;
      o)  output_file=$OPTARG ;;
      r)  randomize=TRUE ;;
      v)  echo $version && exit 0 ;;
      *)  echo "$usage" && exit 1 ;;
   esac
done

if [ $OPTIND -eq 1 ]; then 
   echo "No options were passed"
fi

shift $((OPTIND-1))
if [ ! $# -eq 0 ]; then 
   echo "Non-option argument(s) found: $@"
   echo $usage
   exit 1
fi

if [ ! -d "$input_folder" ]; then
   echo "Invalid input folder: $input_folder"
   echo $usage
   exit 1
fi

if [ -w $output_file  ]; then                                                                                               
   echo "$output_file already exists, do you want to replace it? - y/n"
   read ANSWER
   case $ANSWER in
      [yY]|yes|Yes|YES) echo "Overwriting $output_file" ;;
      *) echo "${0##*/} stopped" && exit 1 ;;
   esac
fi  

pictures=$(find $input_folder -iname "*.jp*g" -o -iname "*.png" -o -iname "*.gif")   # Get the filenames of the pictures
if [ $randomize ]; then
   pictures=$(echo "$pictures"|sort -R)
fi

write_heading      # Make the XML file
while read -r line; do     
   if [ $cnt -eq 0 ]; then
      write_static
   else
      write_transition
      write_static
   fi
   ((cnt++))
   prevline=$line
done <<< "$pictures"
write_tail

echo "Slideshow '$output_file' created with $cnt images."
